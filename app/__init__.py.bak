# app/__init__.py
from flask import Flask
from config import Config
from extensions import db, migrate, jwt, login_manager
from flask_cors import CORS

def create_app():
    app = Flask(__name__, instance_relative_config=False)
    app.config.from_object(Config)

    # Straightforward middleware / extensions
    CORS(app, supports_credentials=True)
    db.init_app(app)
    migrate.init_app(app, db)
    jwt.init_app(app)
    login_manager.init_app(app)

    # Register blueprints: try both top-level 'routes' and package 'app.routes'
    route_modules = [
        ("routes.auth_routes", "/auth"),
        ("routes.product_routes", "/products"),
        ("routes.order_routes", "/orders"),
        ("routes.review_routes", "/reviews"),
        ("routes.wishlist_routes", "/wishlist"),
        ("routes.webhook_routes", "/webhooks"),
        ("routes.admin_routes", "/admin"),
    ]

    for module_name, prefix in route_modules:
        try:
            mod = __import__(module_name, fromlist=["bp"])
            bp = getattr(mod, "bp", None)
            if bp:
                app.register_blueprint(bp, url_prefix=prefix)
        except Exception:
            # try fallback under app package (some repos use app.routes.*)
            try:
                pkg_mod = __import__("app." + module_name.split(".",1)[1], fromlist=["bp"])
                bp = getattr(pkg_mod, "bp", None)
                if bp:
                    app.register_blueprint(bp, url_prefix=prefix)
            except Exception:
                # missing blueprint or module: ignore (we'll add routes later)
                pass

    return app
